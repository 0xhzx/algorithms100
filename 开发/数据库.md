# 数据库

数据库结构化存储数据，最常考察数据库的问题:sql语句 索引  事务 性能，最常考的数据库种类有关系型数据库、内存数据库、分布式数据库。
此文先以最常见的MySQL数据库说明数据库，之后讲解Redis、数据库集群。
典型数据库：
关系型数据库 MySQL
内存数据库 Redis
分布式数据库 数据库集群、大数据数据库

## sql语句
https://zhuanlan.zhihu.com/p/50662216

## 索引 
### 索引的数据结构
索引用来加快数据查找速度，IO最耗时，自然地使用B*索引。m树可以缩减到三层，且有序为B树，相邻叶节点前后相继为B+树，隔层节点前后相继为B*树。
跳表为底层索引建立区间哨兵，调整更方便，用于Redis。
KD树、R树适合多维搜索。
散列索引一个桶时更快，而数据库不只查一条，那可用于局部散列；或者散列分发到到大桶，大桶的视野内再选。
综上，B*树索引效率、空间、功能、复杂度都很实惠。

### 聚簇索引 覆盖索引 联合索引
带数据的索引称为聚簇索引，InnoDB使用B*树聚簇索引，索引于数据文件紧密结合，更快，更难修改。MyIASM索引存储行指针，可以独立于记录文件。
末级索引于记录一一对应，而且聚簇索引主键只能有一个，非主键索引末级只能查所属主键。不能存储行记录指针，因为行记录指针会变而指针不会变。得到主键后再从主键索引查的过程称为回表。非主键索引亦称二级索引、普通索引、辅助索引。
若果是查询某个键值数量一类问题，仅仅查到索引而不需要查到行记录内容，不需要回表，称为覆盖索引。
ABC多列联合索引，则先按A值分、再按B值分、再按C值分，相当支持A、AB、ABC三种索引，称为最左前缀匹配。

## 事务
安全、日志
数据库存储核心数据，为了安全，存储上要落盘、日志护航。
有时候要完成一个目的需要数据库一系列操作，称为事务。如转账，需要源账户减额，的账户增额。
事务由原子性、一致性、隔离性、持久性。
隔离性是事务之间互相隔离，为了解决脏读（读未提交）、不可重复读、幻读。
不可重复读：事务A过程中中，因为事务B已提交，所以事务A过程中的多次读结果不同。要解决此问题需要行写锁。
幻读：如果另一事务插入数据，那么对已有数据加写锁也不够用了，所以对整张表加写锁（串行化）。即便另一事务新增行记录，本事务统计记录总数亦不变。
MySQL隔离级别：读未提交、读已提交、可重复读（默认）、串行化。
InnoDB才有事务，串行化使用MVCC（多版本并发控制）实现，为行记录增添诞生时间（版本号）、过期时间（版本号），开启事务后版本号递增。
多版本并发控制在CAS、大数据拜票中使用。

## 性能
互联网请求中数据库的时间花费较多，所以常常前置缓存。数据库事务耗时多，所以常用键值对存储、内存型、减少结构、优化查询逻辑、主从复制、分库分表等办法。

###  索引下推
MySQL5.6引入索引下推，以剪枝搜索。如在ABC索引中，查询ABC条件，并不会逐A、B、C依次回表判断，而是得到索引节点后，对节点的A、B、C值域于查询条件相比较，尽早剪枝。

## redis
redis是内存行数据库，是典型的NoSQL，不仅仅是SQL，为追求高效而生，单线程。持久化有增量日志、快照。存储类型有     String     Hash     List     Set     Sorted set。
有序集合zset主要有两种编码方式：REDIS_ENCODING_ZIPLIST和REDIS_ENCODING_SKIPLIST。较小的（64）有序集合使用ziplist。REDIS_ENCODING_SKIPLIST包含了跳表和散列。跳表已于范围搜索，散列已于单桶搜索。跳表占用空间比b树大，更容易修改。
由此可见redis为了速度多用空间。
redis大批量记录同时过期时并不会同时销毁，而是每次随机选一批回收，有一定缓冲性，防止雪崩。

## 大规模数据库
OLTP（On-Line Transaction Processing，联机事务处理）适合处理事务，MySQL。
OLAP（On-Line Analytical Processing，联机分析处理）是基于数据仓库的信息分析处理过程，HBase。
列式存储

### LSM树
数据库写入慢，加上缓存，批量写入。要查询时得在内存中先看看是否需要更新。所以LSM树牺牲了少量读性能，大幅提高写性能。



